<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="Keywords" content="blog"/>
    <meta name="Description" content="blog"/>
    <title>Simple</title>
    <link rel="shortcut icon" href="/static/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="/main.css" />
</head>
<body>
<div class="main">
    <div class="header">
    	<ul id="pages">
            <li><a href="/">home</a></li>
            <li><a href="/#/tags">tags</a></li>
            <li><a href="/#/archive">archive</a></li>
    	</ul>
    </div>
	<div class="wrap-header">
	<h1>
    <a href="/" id="title"></a>
	</h1>
	</div>
<div id="md" style="display: none;">
<!-- markdown -->
<article class="post-690 post type-post status-publish format-standard hentry category-linux-2 tag-nginx" id="post-690">
		<div class="entry">
			<p><img class="aligncenter" alt="" src="http://img.jybb.me/jybb/nginx-logo.png"></p>
<p>发现以前写的几篇教程，挺模糊的，有人看了摸不清头脑。（由于当时我也不太懂……），现在重新写一遍，并增加注释。</p>
<p>如果你用的是<a href="http://lnmp.org" target="_blank">军哥的LNMP</a>，而且又需要替换内容，则需要重新编译nginx。如果不需要替换内存，仅用于加速自己的网站，则不需要重新编译。</p>
<p><span style="color: #800080;">1.安装Nginx</span></p>
<p>你可以用源安装/编译安装/一键包（此处省略）</p>
<p><span style="color: #800080;">2.新增虚拟主机配置文件用于反代</span></p>
<p>找到您的nginx conf所在位置，一般编译的在/usr/local/nginx/conf/，从源安装的在/etc/nginx</p>
<p>在nginx.conf的http层加入以下内容：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a482391803852" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">proxy_connect_timeout    5;
proxy_read_timeout       60;
proxy_send_timeout       5;
proxy_buffer_size        16k;
proxy_buffers            4 64k;
proxy_busy_buffers_size 128k;
proxy_temp_file_write_size 128k;
proxy_temp_path   /home/cache/temp;
#临时文件目录
proxy_cache_path  /home/cache/path levels=1:2 keys_zone=cache_one:5m inactive=7d max_size=1g;
#5m为内存占用，1g为最大硬盘占用，cache_one为缓存区名字，如果修改则下文的配置亦要相应修改。</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a482391803852-1"><span class="crayon-v">proxy_connect</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-2"><span class="crayon-v">proxy_read</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">60</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-3"><span class="crayon-v">proxy_send</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-4"><span class="crayon-v">proxy_buffer</span><span class="crayon-sy">_</span>size<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">16k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-5"><span class="crayon-v">proxy</span><span class="crayon-sy">_</span>buffers<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-cn">64k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-6"><span class="crayon-v">proxy_busy_buffers</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-7"><span class="crayon-v">proxy_temp_file_write</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-8"><span class="crayon-v">proxy_temp_path</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-v">temp</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-9"><span class="crayon-p">#临时文件目录</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-10"><span class="crayon-v">proxy_cache_path</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-e">path </span><span class="crayon-v">levels</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-v">keys_zone</span><span class="crayon-o">=</span><span class="crayon-v">cache_one</span><span class="crayon-o">:</span><span class="crayon-cn">5m</span><span class="crayon-h"> </span><span class="crayon-v">inactive</span><span class="crayon-o">=</span><span class="crayon-cn">7d</span><span class="crayon-h"> </span><span class="crayon-v">max_size</span><span class="crayon-o">=</span><span class="crayon-cn">1g</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-11"><span class="crayon-p">#5m为内存占用，1g为最大硬盘占用，cache_one为缓存区名字，如果修改则下文的配置亦要相应修改。</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0017 seconds] -->
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a48a938487816" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">mkdir /home/cache/path -p
mkdir /home/cache/temp
chmod 777 -R /home/cache</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a48a938487816-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48a938487816-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a48a938487816-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a48a938487816-1"><span class="crayon-v">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-v">path</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48a938487816-2"><span class="crayon-v">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-e">temp</span></div><div class="crayon-line" id="crayon-5b75666d9a48a938487816-3"><span class="crayon-i">chmod</span><span class="crayon-h"> </span><span class="crayon-cn">777</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">R</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>新增虚拟主机配置：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a48d981816307" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">vi /usr/local/nginx/conf/vhost/example.com.conf  
#example.com是你要绑定的域名</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a48d981816307-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48d981816307-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a48d981816307-1"><span class="crayon-v">vi</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">/</span><span class="crayon-v">conf</span><span class="crayon-o">/</span><span class="crayon-v">vhost</span><span class="crayon-o">/</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span><span class="crayon-h">&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48d981816307-2"><span class="crayon-p">#example.com是你要绑定的域名</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>配置文件内容：{后端（ip为1.2.3.4）绑定域名example.com，前端绑定域名example.com，域名解析到前端，实现cdn加速。}</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a48f795935093" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">server{
listen 80;
server_name example.com www.example.com;    
#绑定的域名

index index.php;      
#默认首页

access_log off;		
#off 关闭日志

location / {
proxy_cache_key "$scheme://$host$request_uri";
#缓存key规则，用于自动清除缓存。

proxy_cache cache_one; 
#缓存区名称，与前面定义的相同

proxy_cache_valid &nbsp;200 304 3h;
proxy_cache_valid 301 3d;
proxy_cache_valid any 10s;
#200 304状态缓存3小时
301状态缓存3天
其他状态缓存（如502 404）10秒

proxy_set_header   X-Real-IP  $remote_addr;
proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
#向后端传递访客ip

proxy_set_header   Referer http://example.com;	
#强制定义Referer，程序验证判断会用到

proxy_set_header   Host $host;
#定义主机头

proxy_pass http://1.2.3.4;	
#指定后端ip，可以加端口

#proxy_cache_use_stale invalid_header error timeout http_502;
#当后端出现错误、超时、502状态时启用过期缓存，慎用。
        }
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-12">12</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-14">14</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-16">16</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-18">18</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-20">20</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-22">22</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-24">24</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-26">26</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-28">28</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-30">30</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-32">32</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-34">34</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-36">36</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-38">38</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-40">40</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-42">42</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a48f795935093-1"><span class="crayon-e">server</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-2"><span class="crayon-i">listen</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-3"><span class="crayon-e">server_name </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">com </span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-4"><span class="crayon-p">#绑定的域名</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-6"><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">php</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-7"><span class="crayon-p">#默认首页</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-8">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-9"><span class="crayon-e">access_log </span><span class="crayon-v">off</span><span class="crayon-sy">;</span><span class="crayon-h">		</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-10"><span class="crayon-p">#off 关闭日志</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-12"><span class="crayon-e">location</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-13"><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>key<span class="crayon-h"> </span><span class="crayon-s">"$scheme://$host$request_uri"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-14"><span class="crayon-p">#缓存key规则，用于自动清除缓存。</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-16"><span class="crayon-e">proxy_cache </span><span class="crayon-v">cache_one</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-17"><span class="crayon-p">#缓存区名称，与前面定义的相同</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-18">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-19"><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h"> </span>&nbsp;<span class="crayon-cn">200</span><span class="crayon-h"> </span><span class="crayon-cn">304</span><span class="crayon-h"> </span><span class="crayon-cn">3h</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-20"><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h"> </span><span class="crayon-cn">301</span><span class="crayon-h"> </span><span class="crayon-cn">3d</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-21"><span class="crayon-e">proxy_cache_valid </span><span class="crayon-i">any</span><span class="crayon-h"> </span><span class="crayon-cn">10s</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-22"><span class="crayon-p">#200 304状态缓存3小时</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-23"><span class="crayon-cn">301</span>状态缓存<span class="crayon-cn">3</span>天</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-24">其他状态缓存（如<span class="crayon-cn">502</span><span class="crayon-h"> </span><span class="crayon-cn">404</span>）<span class="crayon-cn">10</span>秒</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-25">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-26"><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Real</span><span class="crayon-o">-</span><span class="crayon-i">IP</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-v">remote_addr</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-27"><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Forwarded</span><span class="crayon-o">-</span><span class="crayon-st">For</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">proxy_add_x_forwarded_for</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-28"><span class="crayon-p">#向后端传递访客ip</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-29">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-30"><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-e">Referer </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//example.com;	</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-31"><span class="crayon-p">#强制定义Referer，程序验证判断会用到</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-32">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-33"><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-i">Host</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">host</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-34"><span class="crayon-p">#定义主机头</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-35">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-36"><span class="crayon-e">proxy_pass </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//1.2.3.4;	</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-37"><span class="crayon-p">#指定后端ip，可以加端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-38">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-39"><span class="crayon-p">#proxy_cache_use_stale invalid_header error timeout http_502;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-40"><span class="crayon-p">#当后端出现错误、超时、502状态时启用过期缓存，慎用。</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-42"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0024 seconds] -->
<p>如无意外，重启nginx后把example.com绑定到前端就可以访问了</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a492981153493" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">/etc/init.d/nginx restart</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a492981153493-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a492981153493-1"><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">init</span><span class="crayon-sy">.</span><span class="crayon-v">d</span><span class="crayon-o">/</span><span class="crayon-e">nginx </span><span class="crayon-v">restart</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>&nbsp;</p>
<p>下面介绍的是反代别人的网站（类似于小偷），并替换相关内容</p>
<p><span style="color: #800080;">1.编译nginX：</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a494606731654" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">cd /root
apt-get update
apt-get install -y git gcc g++ make automake
#安装依赖包，Centos将apt-get更改为yum
git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module
wget http://nginx.org/download/nginx-1.2.8.tar.gz
tar zxvf nginx-1.2.8.tar.gz
cd nginx-1.2.8
./configure --user=www --group=www --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-ipv6 --with-http_sub_module --add-module=/root/ngx_http_substitutions_filter_module
make
make install</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-11">11</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a494606731654-1"><span class="crayon-v">cd</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">root</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-2"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">update</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-3"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-e">git </span><span class="crayon-i">gcc</span><span class="crayon-h"> </span><span class="crayon-v">g</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-e">make </span><span class="crayon-v">automake</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-4"><span class="crayon-p">#安装依赖包，Centos将apt-get更改为yum</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-5"><span class="crayon-e">git </span><span class="crayon-r">clone</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//github.com/yaoweibin/ngx_http_substitutions_filter_module</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-6"><span class="crayon-e">wget </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//nginx.org/download/nginx-1.2.8.tar.gz</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-7"><span class="crayon-e">tar </span><span class="crayon-e">zxvf </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-cn">1.2.8.tar.gz</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-8"><span class="crayon-e">cd </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-cn">1.2.8</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-9"><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">configure</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">user</span><span class="crayon-o">=</span><span class="crayon-v">www</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">group</span><span class="crayon-o">=</span><span class="crayon-v">www</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">prefix</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_stub_status_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_ssl_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_gzip_static_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">ipv6</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_sub_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">add</span><span class="crayon-o">-</span><span class="crayon-v">module</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">root</span><span class="crayon-o">/</span><span class="crayon-e">ngx_http_substitutions_filter_module</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-10"><span class="crayon-e">make</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-11"><span class="crayon-e">make </span><span class="crayon-v">install</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>如果您用的系统是Debian，就不需要编译了。</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a4a1052010264" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">echo "deb http://packages.dotdeb.org squeeze all" &gt;&gt;/etc/apt/sources.list
echo "deb-src http://packages.dotdeb.org squeeze all" &gt;&gt;/etc/apt/sources.list
#添加dotdeb源，已多次介绍dotdeb源的好处
apt-get update
apt-get install nginx-full
#nginx-full这个包里面包含着所有需要用到的模块。</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a4a1052010264-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4a1052010264-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a4a1052010264-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4a1052010264-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a4a1052010264-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4a1052010264-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a4a1052010264-1"><span class="crayon-i">echo</span><span class="crayon-h"> </span><span class="crayon-s">"deb http://packages.dotdeb.org squeeze all"</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">apt</span><span class="crayon-o">/</span><span class="crayon-v">sources</span><span class="crayon-sy">.</span><span class="crayon-e">list</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4a1052010264-2"><span class="crayon-i">echo</span><span class="crayon-h"> </span><span class="crayon-s">"deb-src http://packages.dotdeb.org squeeze all"</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">apt</span><span class="crayon-o">/</span><span class="crayon-v">sources</span><span class="crayon-sy">.</span><span class="crayon-v">list</span></div><div class="crayon-line" id="crayon-5b75666d9a4a1052010264-3"><span class="crayon-p">#添加dotdeb源，已多次介绍dotdeb源的好处</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4a1052010264-4"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">update</span></div><div class="crayon-line" id="crayon-5b75666d9a4a1052010264-5"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">full</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4a1052010264-6"><span class="crayon-p">#nginx-full这个包里面包含着所有需要用到的模块。</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0007 seconds] -->
<p><span style="color: #800080;">2.修改nginx.conf</span></p>
<p>编译的在/usr/local/nginx/conf/nginx.conf，源安装的在/etc/nginx/nginx.conf</p>
<p>以example.com反代www.baidu.com并替换内容为例：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

		<div id="crayon-5b75666d9a4b0577134811" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">
		
			<div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">user  www;
worker_processes  2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
error_log  logs/error.log  info;
pid        logs/nginx.pid;

events {
                use epoll;
    worker_connections  1024;
}

http {
 … #此处省略一万字
                proxy_connect_timeout    5;
                proxy_read_timeout       60;
                proxy_send_timeout       5;
                proxy_buffer_size        16k;
                proxy_buffers            4 64k;
                proxy_busy_buffers_size 128k;
                proxy_temp_file_write_size 128k;
                proxy_temp_path   /home/cache/temp;
                proxy_cache_path  /home/cache/one levels=1:2 keys_zone=cache_one:3m inactive=7d max_size=1g; 

server {
   listen       80;
   server_name  example.com;
   index index.php;      
        #默认首页

  location / {
    subs_filter_types text/html text/css text/xml;
&nbsp; &nbsp; subs_filter www.baidu.com example.com gi;
#替换模块，下文详解。

    proxy_cache_key "$scheme://$host$request_uri";
#缓存key规则，用于自动清除缓存。

    proxy_cache cache_one; 
#缓存区名称，必须与前面定义的相同

    proxy_cache_valid  200 304 3h;
    proxy_cache_valid 301 3d;
    proxy_cache_valid any 10s;
#200 304状态缓存3小时
#301状态缓存3天
#其他状态缓存（如502 404）10秒

    proxy_set_header   X-Real-IP  $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
#向后端传递访客ip

    proxy_set_header   Referer http://www.baidu.com;	
#强制定义Referer，程序验证判断会用到

    proxy_set_header   Host www.baidu.com;
#定义主机头

    proxy_pass http://1.2.3.4;	
#指定后端ip

    proxy_set_header Accept-Encoding "";	
#清除编码

   proxy_cache_use_stale invalid_header error timeout http_502;
#当后端出现错误、超时、502状态时启用过期缓存
        }
    }
}</textarea></div>
			<div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
				<table class="crayon-table" style="">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-12">12</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-14">14</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-16">16</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-18">18</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-20">20</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-22">22</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-24">24</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-26">26</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-28">28</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-30">30</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-32">32</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-34">34</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-36">36</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-38">38</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-40">40</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-42">42</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-44">44</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-46">46</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-48">48</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-50">50</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-52">52</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-54">54</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-56">56</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-58">58</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-60">60</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-62">62</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-64">64</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-66">66</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-68">68</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-70">70</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-1"><span class="crayon-e">user&nbsp;&nbsp;</span><span class="crayon-v">www</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-2"><span class="crayon-v">worker</span><span class="crayon-sy">_</span>processes<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">2</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-4"><span class="crayon-p">#error_log&nbsp;&nbsp;logs/error.log;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-5"><span class="crayon-p">#error_log&nbsp;&nbsp;logs/error.log&nbsp;&nbsp;notice;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-6"><span class="crayon-e">error_log&nbsp;&nbsp;</span><span class="crayon-v">logs</span><span class="crayon-o">/</span><span class="crayon-v">error</span><span class="crayon-sy">.</span><span class="crayon-e">log&nbsp;&nbsp;</span><span class="crayon-v">info</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-7"><span class="crayon-e">pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">logs</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-sy">.</span><span class="crayon-v">pid</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-8">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-9"><span class="crayon-e">events</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">use</span><span class="crayon-h"> </span><span class="crayon-v">epoll</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">worker</span><span class="crayon-sy">_</span>connections<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1024</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-12"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-14"><span class="crayon-e">http</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-15"><span class="crayon-h"> </span>…<span class="crayon-h"> </span><span class="crayon-p">#此处省略一万字</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_connect</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_read</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">60</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_send</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_buffer</span><span class="crayon-sy">_</span>size<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">16k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy</span><span class="crayon-sy">_</span>buffers<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-cn">64k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_busy_buffers</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_temp_file_write</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_temp_path</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-v">temp</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache_path</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-e">one </span><span class="crayon-v">levels</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-v">keys_zone</span><span class="crayon-o">=</span><span class="crayon-v">cache_one</span><span class="crayon-o">:</span><span class="crayon-cn">3m</span><span class="crayon-h"> </span><span class="crayon-v">inactive</span><span class="crayon-o">=</span><span class="crayon-cn">7d</span><span class="crayon-h"> </span><span class="crayon-v">max_size</span><span class="crayon-o">=</span><span class="crayon-cn">1g</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-25">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-26"><span class="crayon-e">server</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-27"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-i">listen</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">80</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-28"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">server_name&nbsp;&nbsp;</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-29"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">php</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p">#默认首页</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-31">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-32"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">location</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">subs_filter_types </span><span class="crayon-v">text</span><span class="crayon-o">/</span><span class="crayon-e">html </span><span class="crayon-v">text</span><span class="crayon-o">/</span><span class="crayon-e">css </span><span class="crayon-v">text</span><span class="crayon-o">/</span><span class="crayon-v">xml</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-34">&nbsp;<span class="crayon-h"> </span>&nbsp;<span class="crayon-h"> </span><span class="crayon-e">subs_filter </span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">baidu</span><span class="crayon-sy">.</span><span class="crayon-e">com </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">com </span><span class="crayon-v">gi</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-35"><span class="crayon-p">#替换模块，下文详解。</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-36">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>key<span class="crayon-h"> </span><span class="crayon-s">"$scheme://$host$request_uri"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-38"><span class="crayon-p">#缓存key规则，用于自动清除缓存。</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-39">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_cache </span><span class="crayon-v">cache_one</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-41"><span class="crayon-p">#缓存区名称，必须与前面定义的相同</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-42">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">200</span><span class="crayon-h"> </span><span class="crayon-cn">304</span><span class="crayon-h"> </span><span class="crayon-cn">3h</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h"> </span><span class="crayon-cn">301</span><span class="crayon-h"> </span><span class="crayon-cn">3d</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_cache_valid </span><span class="crayon-i">any</span><span class="crayon-h"> </span><span class="crayon-cn">10s</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-46"><span class="crayon-p">#200 304状态缓存3小时</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-47"><span class="crayon-p">#301状态缓存3天</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-48"><span class="crayon-p">#其他状态缓存（如502 404）10秒</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-49">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Real</span><span class="crayon-o">-</span><span class="crayon-i">IP</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-v">remote_addr</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Forwarded</span><span class="crayon-o">-</span><span class="crayon-st">For</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">proxy_add_x_forwarded_for</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-52"><span class="crayon-p">#向后端传递访客ip</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-53">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-e">Referer </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//www.baidu.com;	</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-55"><span class="crayon-p">#强制定义Referer，程序验证判断会用到</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-56">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-e">Host </span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">baidu</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-58"><span class="crayon-p">#定义主机头</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-59">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-60"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_pass </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//1.2.3.4;	</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-61"><span class="crayon-p">#指定后端ip</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-62">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-63"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_set_header </span><span class="crayon-v">Accept</span><span class="crayon-o">-</span><span class="crayon-i">Encoding</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">;</span><span class="crayon-h">	</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-64"><span class="crayon-p">#清除编码</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-65">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-66"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">proxy_cache_use_stale </span><span class="crayon-e">invalid_header </span><span class="crayon-e">error </span><span class="crayon-e">timeout </span><span class="crayon-v">http_502</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-67"><span class="crayon-p">#当后端出现错误、超时、502状态时启用过期缓存</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-70"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0057 seconds] -->
<p>温馨提示：如果您要替换的内容里面有<span style="color: #008000;">中文</span>，请将conf文件保存为<span style="color: #ff00ff;">utf-8 without BOM</span>编码。</p>
<p>关于<a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module" target="_blank">ngx_http_substitutions_filter_module</a>的说明：（本模块是中国人写的，但是说明只有英文版，在此我翻译一下）</p>
<p>描述<br>
nginx_substitutions_filter 是一个nginx替换模块，就跟apache的&nbsp;mod_substitute模块一样</p>
<p>使用距离</p>
<p><em id="__mceDel"> location / {</em></p>
<p>subs_filter_types text/html text/css text/xml;<br>
subs_filter st(\d*).example.com $1.example.com ir;<br>
subs_filter a.example.com s.example.com;</p>
<p>}</p>
<p>涉及指令：<br>
* subs_filter_types</p>
<p>* subs_filter</p>
<p>subs_filter_types<br>
语法： *subs_filter_types mime-type [mime-types] *</p>
<p>默认： *subs_filter_types text/html*</p>
<p>内容： *http, server, location*</p>
<p>*subs_filter_types* 是用来指定替换文件类型的<br>
默认仅仅替换text/html类型的文件。</p>
<p><span style="color: #ff00ff;">*如果您反代的论坛出现登录跳转源站之类的问题，请检查这个项目。</span></p>
<p>&nbsp;</p>
<p>proxy_set_header Accept-Encoding "";</p>
<p>subs_filter<br>
语法： *subs_filter source_str destination_str [gior] *</p>
<p>默认： *none*</p>
<p>内容： *http, server, location*</p>
<p>*subs_filter* 是用来替换文本的，可以使用正则</p>
<p>* *g*（默认）：替换匹配项。</p>
<p>* *i*：区分大小写的匹配</p>
<p>* *o*: 只匹配发现的第一个。</p>
<p>* *r*: 正则。</p>
<p>&nbsp;</p>
<p>先讲这么多，有错误欢迎提出。</p>
<p>关于自动清空缓存的，我也没弄明白，先不写了。</p>
<p>&nbsp;</p>
<p><span style="color: #333399;">*参考资料：</span></p>
<p><span style="color: #333399;">Nginx Wiki &nbsp;&nbsp;<a href="http://wiki.nginx.org/HttpProxyModule" target="_blank"><span style="color: #333399;">http://wiki.nginx.org/HttpProxyModule</span></a></span></p>
<p><span style="color: #333399;">YaoWeibin Github &nbsp; &nbsp;<a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module" target="_blank"><span style="color: #333399;">https://github.com/yaoweibin/ngx_http_substitutions_filter_module</span></a></span></p>
			<div class="warning codei" style="display:none">
				<div class="box-content">本博客所有文章如无特别注明均为原创。<br>
				复制或转载请以超链接形式注明转自<a href="https://jybb.me">俊彥博客</a>，原文地址《<a href="https://jybb.me/nginx-proxy-pass" rel="bookmark" title="NginX 反代系列教程（重写）">NginX 反代系列教程（重写）</a>》
				</div>
			</div>
		</div>
	</article>
<!-- markdown end -->
</div>
<div class="entry" id="main">
<!-- content -->
<article class="post-690 post type-post status-publish format-standard hentry category-linux-2 tag-nginx" id="post-690">
        <div class="entry">
            <p><img class="aligncenter" alt="" src="http://img.jybb.me/jybb/nginx-logo.png"></p>
<p>发现以前写的几篇教程，挺模糊的，有人看了摸不清头脑。（由于当时我也不太懂……），现在重新写一遍，并增加注释。</p>
<p>如果你用的是<a href="http://lnmp.org" target="_blank">军哥的LNMP</a>，而且又需要替换内容，则需要重新编译nginx。如果不需要替换内存，仅用于加速自己的网站，则不需要重新编译。</p>
<p><span style="color: #800080;">1.安装Nginx</span></p>
<p>你可以用源安装/编译安装/一键包（此处省略）</p>
<p><span style="color: #800080;">2.新增虚拟主机配置文件用于反代</span></p>
<p>找到您的nginx conf所在位置，一般编译的在/usr/local/nginx/conf/，从源安装的在/etc/nginx</p>
<p>在nginx.conf的http层加入以下内容：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a482391803852" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">proxy_connect_timeout    5;
proxy_read_timeout       60;
proxy_send_timeout       5;
proxy_buffer_size        16k;
proxy_buffers            4 64k;
proxy_busy_buffers_size 128k;
proxy_temp_file_write_size 128k;
proxy_temp_path   /home/cache/temp;
#临时文件目录
proxy_cache_path  /home/cache/path levels=1:2 keys_zone=cache_one:5m inactive=7d max_size=1g;
#5m为内存占用，1g为最大硬盘占用，cache_one为缓存区名字，如果修改则下文的配置亦要相应修改。</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a482391803852-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a482391803852-11">11</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a482391803852-1"><span class="crayon-v">proxy_connect</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-2"><span class="crayon-v">proxy_read</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">60</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-3"><span class="crayon-v">proxy_send</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-4"><span class="crayon-v">proxy_buffer</span><span class="crayon-sy">_</span>size<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">16k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-5"><span class="crayon-v">proxy</span><span class="crayon-sy">_</span>buffers<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-cn">64k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-6"><span class="crayon-v">proxy_busy_buffers</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-7"><span class="crayon-v">proxy_temp_file_write</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-8"><span class="crayon-v">proxy_temp_path</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-v">temp</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-9"><span class="crayon-p">#临时文件目录</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a482391803852-10"><span class="crayon-v">proxy_cache_path</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-e">path </span><span class="crayon-v">levels</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-v">keys_zone</span><span class="crayon-o">=</span><span class="crayon-v">cache_one</span><span class="crayon-o">:</span><span class="crayon-cn">5m</span><span class="crayon-h"> </span><span class="crayon-v">inactive</span><span class="crayon-o">=</span><span class="crayon-cn">7d</span><span class="crayon-h"> </span><span class="crayon-v">max_size</span><span class="crayon-o">=</span><span class="crayon-cn">1g</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a482391803852-11"><span class="crayon-p">#5m为内存占用，1g为最大硬盘占用，cache_one为缓存区名字，如果修改则下文的配置亦要相应修改。</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0017 seconds] -->
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a48a938487816" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">mkdir /home/cache/path -p
mkdir /home/cache/temp
chmod 777 -R /home/cache</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a48a938487816-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48a938487816-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a48a938487816-3">3</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a48a938487816-1"><span class="crayon-v">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-v">path</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48a938487816-2"><span class="crayon-v">mkdir</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-e">temp</span></div><div class="crayon-line" id="crayon-5b75666d9a48a938487816-3"><span class="crayon-i">chmod</span><span class="crayon-h"> </span><span class="crayon-cn">777</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">R</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0010 seconds] -->
<p>新增虚拟主机配置：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a48d981816307" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">vi /usr/local/nginx/conf/vhost/example.com.conf  
#example.com是你要绑定的域名</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a48d981816307-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48d981816307-2">2</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a48d981816307-1"><span class="crayon-v">vi</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-o">/</span><span class="crayon-v">conf</span><span class="crayon-o">/</span><span class="crayon-v">vhost</span><span class="crayon-o">/</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">.</span><span class="crayon-v">conf</span><span class="crayon-h">&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48d981816307-2"><span class="crayon-p">#example.com是你要绑定的域名</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0004 seconds] -->
<p>配置文件内容：{后端（ip为1.2.3.4）绑定域名example.com，前端绑定域名example.com，域名解析到前端，实现cdn加速。}</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a48f795935093" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">server{
listen 80;
server_name example.com www.example.com;    
#绑定的域名

index index.php;      
#默认首页

access_log off;        
#off 关闭日志

location / {
proxy_cache_key "$scheme://$host$request_uri";
#缓存key规则，用于自动清除缓存。

proxy_cache cache_one; 
#缓存区名称，与前面定义的相同

proxy_cache_valid &nbsp;200 304 3h;
proxy_cache_valid 301 3d;
proxy_cache_valid any 10s;
#200 304状态缓存3小时
301状态缓存3天
其他状态缓存（如502 404）10秒

proxy_set_header   X-Real-IP  $remote_addr;
proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
#向后端传递访客ip

proxy_set_header   Referer http://example.com;    
#强制定义Referer，程序验证判断会用到

proxy_set_header   Host $host;
#定义主机头

proxy_pass http://1.2.3.4;    
#指定后端ip，可以加端口

#proxy_cache_use_stale invalid_header error timeout http_502;
#当后端出现错误、超时、502状态时启用过期缓存，慎用。
        }
}</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-12">12</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-14">14</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-16">16</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-18">18</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-20">20</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-22">22</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-24">24</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-26">26</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-28">28</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-30">30</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-32">32</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-34">34</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-36">36</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-38">38</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-40">40</div><div class="crayon-num" data-line="crayon-5b75666d9a48f795935093-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a48f795935093-42">42</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a48f795935093-1"><span class="crayon-e">server</span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-2"><span class="crayon-i">listen</span><span class="crayon-h"> </span><span class="crayon-cn">80</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-3"><span class="crayon-e">server_name </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">com </span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-4"><span class="crayon-p">#绑定的域名</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-5">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-6"><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">php</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-7"><span class="crayon-p">#默认首页</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-8">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-9"><span class="crayon-e">access_log </span><span class="crayon-v">off</span><span class="crayon-sy">;</span><span class="crayon-h">        </span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-10"><span class="crayon-p">#off 关闭日志</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-11">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-12"><span class="crayon-e">location</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-13"><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>key<span class="crayon-h"> </span><span class="crayon-s">"$scheme://$host$request_uri"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-14"><span class="crayon-p">#缓存key规则，用于自动清除缓存。</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-15">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-16"><span class="crayon-e">proxy_cache </span><span class="crayon-v">cache_one</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-17"><span class="crayon-p">#缓存区名称，与前面定义的相同</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-18">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-19"><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h"> </span>&nbsp;<span class="crayon-cn">200</span><span class="crayon-h"> </span><span class="crayon-cn">304</span><span class="crayon-h"> </span><span class="crayon-cn">3h</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-20"><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h"> </span><span class="crayon-cn">301</span><span class="crayon-h"> </span><span class="crayon-cn">3d</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-21"><span class="crayon-e">proxy_cache_valid </span><span class="crayon-i">any</span><span class="crayon-h"> </span><span class="crayon-cn">10s</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-22"><span class="crayon-p">#200 304状态缓存3小时</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-23"><span class="crayon-cn">301</span>状态缓存<span class="crayon-cn">3</span>天</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-24">其他状态缓存（如<span class="crayon-cn">502</span><span class="crayon-h"> </span><span class="crayon-cn">404</span>）<span class="crayon-cn">10</span>秒</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-25">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-26"><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Real</span><span class="crayon-o">-</span><span class="crayon-i">IP</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-v">remote_addr</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-27"><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Forwarded</span><span class="crayon-o">-</span><span class="crayon-st">For</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">proxy_add_x_forwarded_for</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-28"><span class="crayon-p">#向后端传递访客ip</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-29">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-30"><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-e">Referer </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//example.com;  </span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-31"><span class="crayon-p">#强制定义Referer，程序验证判断会用到</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-32">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-33"><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-i">Host</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">host</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-34"><span class="crayon-p">#定义主机头</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-35">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-36"><span class="crayon-e">proxy_pass </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//1.2.3.4; </span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-37"><span class="crayon-p">#指定后端ip，可以加端口</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-38">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-39"><span class="crayon-p">#proxy_cache_use_stale invalid_header error timeout http_502;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-40"><span class="crayon-p">#当后端出现错误、超时、502状态时启用过期缓存，慎用。</span></div><div class="crayon-line" id="crayon-5b75666d9a48f795935093-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a48f795935093-42"><span class="crayon-sy">}</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0024 seconds] -->
<p>如无意外，重启nginx后把example.com绑定到前端就可以访问了</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a492981153493" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code" style="display: none;"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">/etc/init.d/nginx restart</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a492981153493-1">1</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a492981153493-1"><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">init</span><span class="crayon-sy">.</span><span class="crayon-v">d</span><span class="crayon-o">/</span><span class="crayon-e">nginx </span><span class="crayon-v">restart</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0002 seconds] -->
<p>&nbsp;</p>
<p>下面介绍的是反代别人的网站（类似于小偷），并替换相关内容</p>
<p><span style="color: #800080;">1.编译nginX：</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a494606731654" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">cd /root
apt-get update
apt-get install -y git gcc g++ make automake
#安装依赖包，Centos将apt-get更改为yum
git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module
wget http://nginx.org/download/nginx-1.2.8.tar.gz
tar zxvf nginx-1.2.8.tar.gz
cd nginx-1.2.8
./configure --user=www --group=www --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-ipv6 --with-http_sub_module --add-module=/root/ngx_http_substitutions_filter_module
make
make install</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a494606731654-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a494606731654-11">11</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a494606731654-1"><span class="crayon-v">cd</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-e">root</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-2"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">update</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-3"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-v">install</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">y</span><span class="crayon-h"> </span><span class="crayon-e">git </span><span class="crayon-i">gcc</span><span class="crayon-h"> </span><span class="crayon-v">g</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-e">make </span><span class="crayon-v">automake</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-4"><span class="crayon-p">#安装依赖包，Centos将apt-get更改为yum</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-5"><span class="crayon-e">git </span><span class="crayon-r">clone</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//github.com/yaoweibin/ngx_http_substitutions_filter_module</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-6"><span class="crayon-e">wget </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//nginx.org/download/nginx-1.2.8.tar.gz</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-7"><span class="crayon-e">tar </span><span class="crayon-e">zxvf </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-cn">1.2.8.tar.gz</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-8"><span class="crayon-e">cd </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-cn">1.2.8</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-9"><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">configure</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">user</span><span class="crayon-o">=</span><span class="crayon-v">www</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">group</span><span class="crayon-o">=</span><span class="crayon-v">www</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">prefix</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_stub_status_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_ssl_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_gzip_static_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">ipv6</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">with</span><span class="crayon-o">-</span><span class="crayon-v">http_sub_module</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">add</span><span class="crayon-o">-</span><span class="crayon-v">module</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">root</span><span class="crayon-o">/</span><span class="crayon-e">ngx_http_substitutions_filter_module</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a494606731654-10"><span class="crayon-e">make</span></div><div class="crayon-line" id="crayon-5b75666d9a494606731654-11"><span class="crayon-e">make </span><span class="crayon-v">install</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0016 seconds] -->
<p>如果您用的系统是Debian，就不需要编译了。</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a4a1052010264" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">echo "deb http://packages.dotdeb.org squeeze all" &gt;&gt;/etc/apt/sources.list
echo "deb-src http://packages.dotdeb.org squeeze all" &gt;&gt;/etc/apt/sources.list
#添加dotdeb源，已多次介绍dotdeb源的好处
apt-get update
apt-get install nginx-full
#nginx-full这个包里面包含着所有需要用到的模块。</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a4a1052010264-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4a1052010264-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a4a1052010264-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4a1052010264-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a4a1052010264-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4a1052010264-6">6</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a4a1052010264-1"><span class="crayon-i">echo</span><span class="crayon-h"> </span><span class="crayon-s">"deb http://packages.dotdeb.org squeeze all"</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">apt</span><span class="crayon-o">/</span><span class="crayon-v">sources</span><span class="crayon-sy">.</span><span class="crayon-e">list</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4a1052010264-2"><span class="crayon-i">echo</span><span class="crayon-h"> </span><span class="crayon-s">"deb-src http://packages.dotdeb.org squeeze all"</span><span class="crayon-h"> </span><span class="crayon-o">&gt;&gt;</span><span class="crayon-o">/</span><span class="crayon-v">etc</span><span class="crayon-o">/</span><span class="crayon-v">apt</span><span class="crayon-o">/</span><span class="crayon-v">sources</span><span class="crayon-sy">.</span><span class="crayon-v">list</span></div><div class="crayon-line" id="crayon-5b75666d9a4a1052010264-3"><span class="crayon-p">#添加dotdeb源，已多次介绍dotdeb源的好处</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4a1052010264-4"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">update</span></div><div class="crayon-line" id="crayon-5b75666d9a4a1052010264-5"><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-v">nginx</span><span class="crayon-o">-</span><span class="crayon-v">full</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4a1052010264-6"><span class="crayon-p">#nginx-full这个包里面包含着所有需要用到的模块。</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0007 seconds] -->
<p><span style="color: #800080;">2.修改nginx.conf</span></p>
<p>编译的在/usr/local/nginx/conf/nginx.conf，源安装的在/etc/nginx/nginx.conf</p>
<p>以example.com反代www.baidu.com并替换内容为例：</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css">
<link rel="stylesheet" type="text/css" href="https://jybb.me/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css">

        <div id="crayon-5b75666d9a4b0577134811" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style="margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important; height: auto;">

            <div class="crayon-toolbar" data-settings=" mouseover hide delay" style="font-size: 12px !important; height: 18px !important; line-height: 18px !important; margin-top: -19px; display: none; z-index: 4;"><span class="crayon-title"></span>
            <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button crayon-pressed" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
            <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
            <div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size: 4; font-size: 12px !important; line-height: 15px !important; z-index: 0; opacity: 0; overflow: hidden;" wrap="soft">user  www;
worker_processes  2;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
error_log  logs/error.log  info;
pid        logs/nginx.pid;

events {
                use epoll;
    worker_connections  1024;
}

http {
 … #此处省略一万字
                proxy_connect_timeout    5;
                proxy_read_timeout       60;
                proxy_send_timeout       5;
                proxy_buffer_size        16k;
                proxy_buffers            4 64k;
                proxy_busy_buffers_size 128k;
                proxy_temp_file_write_size 128k;
                proxy_temp_path   /home/cache/temp;
                proxy_cache_path  /home/cache/one levels=1:2 keys_zone=cache_one:3m inactive=7d max_size=1g; 

server {
   listen       80;
   server_name  example.com;
   index index.php;      
        #默认首页

  location / {
    subs_filter_types text/html text/css text/xml;
&nbsp; &nbsp; subs_filter www.baidu.com example.com gi;
#替换模块，下文详解。

    proxy_cache_key "$scheme://$host$request_uri";
#缓存key规则，用于自动清除缓存。

    proxy_cache cache_one; 
#缓存区名称，必须与前面定义的相同

    proxy_cache_valid  200 304 3h;
    proxy_cache_valid 301 3d;
    proxy_cache_valid any 10s;
#200 304状态缓存3小时
#301状态缓存3天
#其他状态缓存（如502 404）10秒

    proxy_set_header   X-Real-IP  $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
#向后端传递访客ip

    proxy_set_header   Referer http://www.baidu.com;    
#强制定义Referer，程序验证判断会用到

    proxy_set_header   Host www.baidu.com;
#定义主机头

    proxy_pass http://1.2.3.4;    
#指定后端ip

    proxy_set_header Accept-Encoding "";    
#清除编码

   proxy_cache_use_stale invalid_header error timeout http_502;
#当后端出现错误、超时、502状态时启用过期缓存
        }
    }
}</textarea></div>
            <div class="crayon-main" style="position: relative; z-index: 1; overflow: hidden;">
                <table class="crayon-table" style="">
                    <tbody><tr class="crayon-row">
                <td class="crayon-nums " data-settings="show">
                    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-2">2</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-4">4</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-6">6</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-8">8</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-10">10</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-12">12</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-14">14</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-16">16</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-18">18</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-20">20</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-22">22</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-24">24</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-26">26</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-28">28</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-30">30</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-32">32</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-34">34</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-36">36</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-38">38</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-40">40</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-42">42</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-44">44</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-46">46</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-48">48</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-50">50</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-52">52</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-54">54</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-56">56</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-58">58</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-60">60</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-62">62</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-64">64</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-66">66</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-68">68</div><div class="crayon-num" data-line="crayon-5b75666d9a4b0577134811-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5b75666d9a4b0577134811-70">70</div></div>
                </td>
                        <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-1"><span class="crayon-e">user&nbsp;&nbsp;</span><span class="crayon-v">www</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-2"><span class="crayon-v">worker</span><span class="crayon-sy">_</span>processes<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">2</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-3">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-4"><span class="crayon-p">#error_log&nbsp;&nbsp;logs/error.log;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-5"><span class="crayon-p">#error_log&nbsp;&nbsp;logs/error.log&nbsp;&nbsp;notice;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-6"><span class="crayon-e">error_log&nbsp;&nbsp;</span><span class="crayon-v">logs</span><span class="crayon-o">/</span><span class="crayon-v">error</span><span class="crayon-sy">.</span><span class="crayon-e">log&nbsp;&nbsp;</span><span class="crayon-v">info</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-7"><span class="crayon-e">pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">logs</span><span class="crayon-o">/</span><span class="crayon-v">nginx</span><span class="crayon-sy">.</span><span class="crayon-v">pid</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-8">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-9"><span class="crayon-e">events</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">use</span><span class="crayon-h"> </span><span class="crayon-v">epoll</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">worker</span><span class="crayon-sy">_</span>connections<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1024</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-12"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-13">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-14"><span class="crayon-e">http</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-15"><span class="crayon-h"> </span>…<span class="crayon-h"> </span><span class="crayon-p">#此处省略一万字</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_connect</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_read</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">60</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_send</span><span class="crayon-sy">_</span>timeout<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_buffer</span><span class="crayon-sy">_</span>size<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">16k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy</span><span class="crayon-sy">_</span>buffers<span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-cn">64k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_busy_buffers</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_temp_file_write</span><span class="crayon-sy">_</span>size<span class="crayon-h"> </span><span class="crayon-cn">128k</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_temp_path</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-v">temp</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache_path</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-o">/</span><span class="crayon-v">home</span><span class="crayon-o">/</span><span class="crayon-v">cache</span><span class="crayon-o">/</span><span class="crayon-e">one </span><span class="crayon-v">levels</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-v">keys_zone</span><span class="crayon-o">=</span><span class="crayon-v">cache_one</span><span class="crayon-o">:</span><span class="crayon-cn">3m</span><span class="crayon-h"> </span><span class="crayon-v">inactive</span><span class="crayon-o">=</span><span class="crayon-cn">7d</span><span class="crayon-h"> </span><span class="crayon-v">max_size</span><span class="crayon-o">=</span><span class="crayon-cn">1g</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-25">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-26"><span class="crayon-e">server</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-27"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-i">listen</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">80</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-28"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">server_name&nbsp;&nbsp;</span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-29"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">index </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">php</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-p">#默认首页</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-31">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-32"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">location</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">subs_filter_types </span><span class="crayon-v">text</span><span class="crayon-o">/</span><span class="crayon-e">html </span><span class="crayon-v">text</span><span class="crayon-o">/</span><span class="crayon-e">css </span><span class="crayon-v">text</span><span class="crayon-o">/</span><span class="crayon-v">xml</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-34">&nbsp;<span class="crayon-h"> </span>&nbsp;<span class="crayon-h"> </span><span class="crayon-e">subs_filter </span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">baidu</span><span class="crayon-sy">.</span><span class="crayon-e">com </span><span class="crayon-v">example</span><span class="crayon-sy">.</span><span class="crayon-e">com </span><span class="crayon-v">gi</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-35"><span class="crayon-p">#替换模块，下文详解。</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-36">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>key<span class="crayon-h"> </span><span class="crayon-s">"$scheme://$host$request_uri"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-38"><span class="crayon-p">#缓存key规则，用于自动清除缓存。</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-39">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_cache </span><span class="crayon-v">cache_one</span><span class="crayon-sy">;</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-41"><span class="crayon-p">#缓存区名称，必须与前面定义的相同</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-42">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">200</span><span class="crayon-h"> </span><span class="crayon-cn">304</span><span class="crayon-h"> </span><span class="crayon-cn">3h</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_cache</span><span class="crayon-sy">_</span>valid<span class="crayon-h"> </span><span class="crayon-cn">301</span><span class="crayon-h"> </span><span class="crayon-cn">3d</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_cache_valid </span><span class="crayon-i">any</span><span class="crayon-h"> </span><span class="crayon-cn">10s</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-46"><span class="crayon-p">#200 304状态缓存3小时</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-47"><span class="crayon-p">#301状态缓存3天</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-48"><span class="crayon-p">#其他状态缓存（如502 404）10秒</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-49">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Real</span><span class="crayon-o">-</span><span class="crayon-i">IP</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">$</span><span class="crayon-v">remote_addr</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">proxy_set</span><span class="crayon-sy">_</span>header<span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">X</span><span class="crayon-o">-</span><span class="crayon-v">Forwarded</span><span class="crayon-o">-</span><span class="crayon-st">For</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-v">proxy_add_x_forwarded_for</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-52"><span class="crayon-p">#向后端传递访客ip</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-53">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-e">Referer </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//www.baidu.com;    </span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-55"><span class="crayon-p">#强制定义Referer，程序验证判断会用到</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-56">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_set_header&nbsp;&nbsp; </span><span class="crayon-e">Host </span><span class="crayon-v">www</span><span class="crayon-sy">.</span><span class="crayon-v">baidu</span><span class="crayon-sy">.</span><span class="crayon-v">com</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-58"><span class="crayon-p">#定义主机头</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-59">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-60"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_pass </span><span class="crayon-v">http</span><span class="crayon-o">:</span><span class="crayon-c">//1.2.3.4; </span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-61"><span class="crayon-p">#指定后端ip</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-62">&nbsp;</div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-63"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">proxy_set_header </span><span class="crayon-v">Accept</span><span class="crayon-o">-</span><span class="crayon-i">Encoding</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-sy">;</span><span class="crayon-h">   </span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-64"><span class="crayon-p">#清除编码</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-65">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-66"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-e">proxy_cache_use_stale </span><span class="crayon-e">invalid_header </span><span class="crayon-e">error </span><span class="crayon-e">timeout </span><span class="crayon-v">http_502</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-67"><span class="crayon-p">#当后端出现错误、超时、502状态时启用过期缓存</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5b75666d9a4b0577134811-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5b75666d9a4b0577134811-70"><span class="crayon-sy">}</span></div></div></td>
                    </tr>
                </tbody></table>
            </div>
        </div>
<!-- [Format Time: 0.0057 seconds] -->
<p>温馨提示：如果您要替换的内容里面有<span style="color: #008000;">中文</span>，请将conf文件保存为<span style="color: #ff00ff;">utf-8 without BOM</span>编码。</p>
<p>关于<a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module" target="_blank">ngx_http_substitutions_filter_module</a>的说明：（本模块是中国人写的，但是说明只有英文版，在此我翻译一下）</p>
<p>描述<br>
nginx_substitutions_filter 是一个nginx替换模块，就跟apache的&nbsp;mod_substitute模块一样</p>
<p>使用距离</p>
<p><em id="__mceDel"> location / {</em></p>
<p>subs_filter_types text/html text/css text/xml;<br>
subs_filter st(\d*).example.com $1.example.com ir;<br>
subs_filter a.example.com s.example.com;</p>
<p>}</p>
<p>涉及指令：<br>
* subs_filter_types</p>
<p>* subs_filter</p>
<p>subs_filter_types<br>
语法： *subs_filter_types mime-type [mime-types] *</p>
<p>默认： *subs_filter_types text/html*</p>
<p>内容： *http, server, location*</p>
<p>*subs_filter_types* 是用来指定替换文件类型的<br>
默认仅仅替换text/html类型的文件。</p>
<p><span style="color: #ff00ff;">*如果您反代的论坛出现登录跳转源站之类的问题，请检查这个项目。</span></p>
<p>&nbsp;</p>
<p>proxy_set_header Accept-Encoding "";</p>
<p>subs_filter<br>
语法： *subs_filter source_str destination_str [gior] *</p>
<p>默认： *none*</p>
<p>内容： *http, server, location*</p>
<p>*subs_filter* 是用来替换文本的，可以使用正则</p>
<p>* *g*（默认）：替换匹配项。</p>
<p>* *i*：区分大小写的匹配</p>
<p>* *o*: 只匹配发现的第一个。</p>
<p>* *r*: 正则。</p>
<p>&nbsp;</p>
<p>先讲这么多，有错误欢迎提出。</p>
<p>关于自动清空缓存的，我也没弄明白，先不写了。</p>
<p>&nbsp;</p>
<p><span style="color: #333399;">*参考资料：</span></p>
<p><span style="color: #333399;">Nginx Wiki &nbsp;&nbsp;<a href="http://wiki.nginx.org/HttpProxyModule" target="_blank"><span style="color: #333399;">http://wiki.nginx.org/HttpProxyModule</span></a></span></p>
<p><span style="color: #333399;">YaoWeibin Github &nbsp; &nbsp;<a href="https://github.com/yaoweibin/ngx_http_substitutions_filter_module" target="_blank"><span style="color: #333399;">https://github.com/yaoweibin/ngx_http_substitutions_filter_module</span></a></span></p>
            <div class="warning codei" style="display:none">
                <div class="box-content">本博客所有文章如无特别注明均为原创。<br>
                复制或转载请以超链接形式注明转自<a href="https://jybb.me">俊彥博客</a>，原文地址《<a href="https://jybb.me/nginx-proxy-pass" rel="bookmark" title="NginX 反代系列教程（重写）">NginX 反代系列教程（重写）</a>》
                </div>
            </div>
        </div>
    </article>
<!-- content end -->
</div>
<br>
<br>
    <div id="disqus_thread"></div>
	<div class="footer">
		<p>© Copyright 2014 by isnowfy, Designed by isnowfy</p>
	</div>
</div>
<script src="main.js"></script>
<script id="content" type="text/mustache">
    <h1>{{title}}</h1>
    <div class="tag">
    {{date}}
    {{#tags}}
    <a href="/#/tag/{{name}}">#{{name}}</a>
    {{/tags}}
    </div>
</script>
<script id="pagesTemplate" type="text/mustache">
    {{#pages}}
    <li>
        <a href="{{path}}">{{title}}</a>
    </li>
    {{/pages}}
</script>
<script>
$(document).ready(function() {
    $.ajax({
        url: "main.json",
        type: "GET",
        dataType: "json",
        success: function(data) {
            $("#title").html(data.name);
            var pagesTemplate = Hogan.compile($("#pagesTemplate").html());
            var pagesHtml = pagesTemplate.render({"pages": data.pages});
            $("#pages").append(pagesHtml);
            //path
            var path = "nginx-proxy-pass.html";
            //path end
            var now = 0;
            for (var i = 0; i < data.posts.length; ++i)
                if (path == data.posts[i].path)
                    now = i;
            var post = data.posts[now];
            var tmp = post.tags.split(" ");
            var tags = [];
            for (var i = 0; i < tmp.length; ++i)
                if (tmp[i].length > 0)
                    tags.push({"name": tmp[i]});
            var contentTemplate = Hogan.compile($("#content").html());
            var contentHtml = contentTemplate.render({"title": post.title, "tags": tags, "date": post.date});
            $("#main").prepend(contentHtml);
            if (data.disqus_shortname.length > 0) {
                var disqus_shortname = data.disqus_shortname;
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        }
    });
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ["\\(", "\\)"]], processEscapes: true}});
</script>
</body>
</html>
